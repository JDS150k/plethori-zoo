<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, width=device-width">
        <!-- http://getbootstrap.com/docs/4.5/ -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <!-- https://favicon.io/emoji-favicons/money-mouth-face/ -->
        <link href="/static/ple.png" rel="icon">
        <link href="/static/styles.css" rel="stylesheet">
        <!-- http://getbootstrap.com/docs/4.5/ -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        <title>Plethori's Zoo of Crypto Creatures - {% block title %}{% endblock %}</title>
    </head>
    <body>
        <div id="frame">
            <img src="/static/frame.jpg" class="img-fluid">
            <!-- REMOVED LATERAL BUTTONS FOR NOW - WILL REPURPOSE TO CYCLE THROUGH ENCLOSURES
            <a id="switchleft" href="..."></a>
            <a id="switchright" href="..."></a>
            -->
            <div class="cell leftcell topcell" id="steak1cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak1"></div>
            </div>
            <div class="cell leftcell midcell" id="steak2cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak2"></div>
            </div>
            <div class="cell leftcell botcell" id="steak3cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak3"></div>
            </div>
            <div class="cell rightcell topcell" id="steak4cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak4"></div>
            </div>
            <div class="cell rightcell midcell" id="steak5cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak5"></div>
            </div>
            <div class="cell rightcell botcell" id="steak6cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak6"></div>
            </div>

            <div id="mainbox">
                {% block img %}{% endblock %}
                <div id="chat">
                    <div class="sender first" id="speech">       
                        <p>
                            <span id="prev" class="blink-txt"></span>
                            <span id="dialogue"></span>
                            <span id="next" class="blink-txt"></span>
                        </p>
                    </div>
                </div>

                <div id="minimapbox"></div>
                <a id="minimap" onclick="openMap()"></a>
                <a id="minihelp" onclick="openHelp()"></a>
                <div id="helpbox">
                    <div class="p-3" style="direction: rtl;">
                        <span class="header">Plethori Zoo Guidebook</span>
                        <p style="direction: ltr;">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                            <br>
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                        </p>
                    </div>
                    <img src="/static/close-button.png" onclick="closeHelp()" class="closer">
                </div>
                <div id="mapbox" class="p-1">
                    <div id="map">
                        <img src="/static/map.png" class="img-fluid">    
                        <a href="etfx-platform?le=etfx-platfrom" title="ETFX Platform" style="position: absolute; left: 49%; top: 52%">ETFX</a>
                        <a href="sustainable-coins?le=sustainable-coins" title="Sustainable Coins" style="position: absolute; left: 14.3%; top: 44.5%">Sustainable Coins</a>
                        <a href="public-coins?le=public-coins" title="Public Coins" style="position: absolute; left: 43%; top: 82%">Public Coins</a>
                        <a href="governance-tokens?le=governance-tokens" title="Governance Tokens" style="position: absolute; left: 8%; top: 63.5%">Governance Tokens</a>
                        <a href="extinct-coins?le=extinct-coins" title="Extinct Coins" style="position: absolute; left: 31.5%; top: 32%">Extinct Coins</a>
                        <a href="private-coins?le=private-coins" title="Private Coins" style="position: absolute; left: 73.5%; top: 65%">Private Coins</a>
                        <a href="privacy-coins?le=privacy-coins" title="Privacy Coins" style="position: absolute; left: 64%; top: 33.5%">Privacy Coins</a>
                        <a href="utility-tokens?le=utility-tokens" title="Utility Tokens" style="position: absolute; left: 74%; top: 47%">Utility Tokens</a>
                        <a href="stable-coins?le=stable-coins" title="Stable Coins" style="position: absolute; left: 67%; top: 78.5%">Stable Coins</a>
                        <a href="security-tokens?le=security-tokens" title="Security Tokens" style="position: absolute; left: 13%; top: 81%">Security Tokens</a>
                    </div>
                    <img src="/static/close-button.png" onclick="closeMap()" class="closer">
                </div>
                <div id="displayer"></div>
            </div>
        </div>

        <script> // helpbox and mapbox functionality
            var helpbox = document.getElementById("helpbox");
            var mapbox = document.getElementById("mapbox");
            var boxcounter = 99999;
            function openHelp() {
                closeMap();
                helpbox.style.visibility = "visible";
                helpbox.style.zIndex = boxcounter;
                boxcounter +=1;
            }
            function closeHelp() {
                helpbox.style.visibility = "hidden";
            }
            function openMap() {
                closeHelp();
                mapbox.style.visibility = "visible";
                mapbox.style.zIndex = boxcounter;
                boxcounter +=1;
            }
            function closeMap() {
                mapbox.style.visibility = "hidden";
            }
        </script>

            


        <script>  // dynamic lateral buttons for view/map/help ... if more are needed simply add into laterals array :)

            // the lateral buttons will be repurposed to cycle around the map clockwise and anticlockwise

            if (latpointer == null) {
                var latpointer = parseInt("{{latpointer}}");
            }
            let laterals = ["map", "view", "help"];
            let n = laterals.length;
            let right = document.getElementById("switchright");
            let left = document.getElementById("switchleft");
            function adjust() {
                let leftpointer = latpointer - 1;
                let rightpointer = latpointer +1;
                right.innerHTML = "<p>" + laterals[(rightpointer % n + n) % n] + "</p>";
                right.href = laterals[(rightpointer % n + n) % n] + "?lp=" + rightpointer + "&le=" + "{{le}}";
                left.innerHTML = "<p>" + laterals[(leftpointer % n + n) % n] + "</p>";
                left.href = laterals[(leftpointer % n + n) % n] + "?lp=" + leftpointer + "&le=" + "{{le}}";
            }
            adjust();
        </script>




        <script> // Generate & display the creature data from the live market
            // store all crypto-creatures in an array
            let creatures = document.getElementsByClassName("creature");
            
            let displayer = document.getElementById("displayer");
            // add listeners to creatures
            for (const creature of creatures){
                creature.addEventListener("mouseout", hideStats);
                
                creature.addEventListener("mouseover", showStats);
                
            }
            // hide stats displayer when necessary
            function hideStats(event) {
                displayer.style.visibility = "hidden"; // hide the displayer on mouseout of creature
            }
            // render and show stats displayer when necessary
            function showStats(event) {
                var symbol = event.target.id;
                // initialise the url for the GET request to retrieve the cryptocurrency data from the market on cryptocompare
                var url = "https://min-api.cryptocompare.com/data/pricemultifull?fsyms=" + symbol + "&tsyms=USD&api_key=f766acea6e0e6deb31d36258b7392e0a6c9b414d358e5e05ba0b72478b731872";  // this works correctly
                fetch(url).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    //initialise the variables we want to display
                    var sPower = data["DISPLAY"][symbol]["USD"]["MKTCAP"];
                    var iPower = data["DISPLAY"][symbol]["USD"]["PRICE"];
                    var growth = data["DISPLAY"][symbol]["USD"]["CHANGEPCT24HOUR"] + "%";
                    var mob = data["DISPLAY"][symbol]["USD"]["TOTALVOLUME24HTO"];
                    var pop = data["DISPLAY"][symbol]["USD"]["CIRCULATINGSUPPLY"];
                    // show the displayer div, and fill it up with content
                    displayer.innerHTML = 
                    "<span class='smlheader'><u>Creature: " + symbol + "</u></span><br>" +
                    "Individual Power (Price): " + iPower + "<br>" +
                    "Mobility (24hr Vol): " + mob + "<br>" + 
                    "Species Power (Mkt Cap): " + sPower + "<br>" + 
                    "Growth (24hr % Change): " + growth + "<br>" + 
                    "Population (Supply): " + pop + "<br>";
                    displayer.style.visibility = "visible";
                });
            }
        </script>
        {% block txt %}{% endblock %}

        <script> // dynamically render the zookeeper's speech from the array in 'block txt' 
            var txtcounter = -1;
            let next1 = document.getElementById("next");
            let prev1 = document.getElementById("prev");
            let dialogue = document.getElementById("dialogue");
            next1.addEventListener("click", NextText);
            prev1.addEventListener("click", PrevText);
            function NextText() {
                txtcounter +=1;
                renderText(txtcounter);
            }
            function PrevText() {
                txtcounter -=1;
                renderText(txtcounter);
            }
            function renderText (txtcounter) {
                dialogue.innerHTML = array[txtcounter];
                if (txtcounter >= 1) {
                    prev1.innerHTML = "&lt&lt&nbsp;&nbsp;&nbsp;";
                } else {
                    prev1.innerHTML = "";
                }
                if (txtcounter <= array.length - 2) {
                    next1.innerHTML = "&nbsp;&nbsp;&nbsp;&gt&gt";
                } else {
                    next1.innerHTML = "";
                }
            }
            NextText();

            // dynamically generate zookeeper bubbles
            // initialise keeper and bubbles
            var chatopen = false;
            var keeper = document.getElementById("zookeeper");
            var alertBub = document.createElement("img");
            alertBub.setAttribute("src", "/static/alert-bubble.png")
            var closeBub = document.createElement("img");
            closeBub.setAttribute("src", "/static/close-bubble.png")
            var chat = document.getElementById("chat");
            // style the bubbles
            closeBub.style.width = alertBub.style.width = "40%";
            closeBub.style.height = alertBub.style.height = "40%";
            closeBub.style.position = alertBub.style.position = "absolute";
            closeBub.style.left = alertBub.style.left = "60%";
            closeBub.style.top = alertBub.style.top = "20%";
            alertBub.classList.add("blink-image");
            closeBub.classList.add("blink-image");
            keeper.appendChild(alertBub); // start with the alert bubble 
            // listen for clicks on bubbles, and show/hide chat (and change bubbles) accordingly
            keeper.addEventListener("click", function() {
                if (chatopen == false) {
                    chat.style.visibility = "visible";
                    chatopen = true;
                    keeper.removeChild(alertBub);
                    keeper.appendChild(closeBub);
                } else {
                    chat.style.visibility = "hidden";
                    chatopen = false;    
                    keeper.removeChild(closeBub);
                    keeper.appendChild(alertBub);
                    txtcounter = -1;
                    NextText();
                }
            });
        
        </script>

        
        <script>
            var staked = 0;
            // DRAG-AND-DROP STEAKS
            function sound(src) {
                this.sound = document.createElement("audio");
                this.sound.src = src;
                this.sound.setAttribute("preload", "auto");
                this.sound.setAttribute("controls", "none");
                this.sound.style.display = "none";
                document.body.appendChild(this.sound);
                this.play = function(){
                    this.sound.play();
                }
                this.stop = function(){
                    this.sound.pause();
                }
            }
            var zap = new sound("/static/zap.wav");
            
            let isDragging = false;
            let z = 999;
            document.addEventListener('mousedown', function(event) {
                
                let steakx = document.getElementById("steakx"); // Will need to change this to an array of steakx, and fallback accordingly
                // TODO - next 2 lines should occur on screen resize as well as screen load
                let widthRatio = steakx.parentElement.clientWidth / document.documentElement.clientWidth;
                let heightRatio = steakx.parentElement.clientHeight / document.documentElement.clientHeight;
                let dragElement = event.target.closest('.draggable');

                var toptarg = dragElement.getBoundingClientRect()["top"];
                var lefttarg = dragElement.getBoundingClientRect()["left"];
                var originL = dragElement.style.left;
                var originT = dragElement.style.top;
                var originW = dragElement.style.width;
                var originH = dragElement.style.height;

                if (!dragElement) return;
                event.preventDefault();
                dragElement.style.zIndex = z;
                z++;
                dragElement.ondragstart = function() {
                    return false;
                };
                let shiftX, shiftY;

                startDrag(dragElement, event.clientX, event.clientY);
                function onMouseUp(event) {
                    finishDrag();
                };
                function onMouseMove(event) {
                    moveAt(event.clientX, event.clientY);
                }

                // on drag start:
                //   remember the initial shift
                //   move the element position:fixed and a direct child of body
                function startDrag(element, clientX, clientY) {
                    if(isDragging) {
                        return;
                    }
                    isDragging = true;
                    document.addEventListener('mousemove', onMouseMove);
                    element.addEventListener('mouseup', onMouseUp);
                    shiftX = clientX - element.getBoundingClientRect().left;
                    shiftY = clientY - element.getBoundingClientRect().top;

                    //account for new position fixed, which will change the size coz it goes from a % of parent to % of viewport
                    element.style.position = 'fixed';
                    element.style.width = Math.round(element.clientWidth * widthRatio) + "px";
                    element.style.height = Math.round(element.clientHeight * heightRatio) + "px";

                    moveAt(clientX, clientY);
                };
                // switch to absolute coordinates at the end, to fix the element in the document
                function finishDrag() {
                    if(!isDragging) {
                        return;
                    }
                    isDragging = false;
                    dragElement.style.top = parseInt(dragElement.style.top) + 'px';
                    dragElement.classList.remove('draggable');
                    document.removeEventListener('mousemove', onMouseMove);
                    dragElement.removeEventListener('mouseup', onMouseUp);
                    var van = null;
                    function eatAnimation() {
                        zap.play();
                        // animate steak to disappear
                        clearInterval(van);
                        van = setInterval(vanish, 1);
                        function vanish() {
                            if (dragElement.clientWidth <= 5) {
                                dragElement.classList.remove('draggable');
                                dragElement.style.display = "none";
                                clearInterval(van);
                            } else {
                                dragElement.style.left = parseInt(dragElement.style.left.slice(0, -2)) + (0.05 * dragElement.clientWidth) + "px";
                                dragElement.style.width = (parseInt(dragElement.style.width.slice(0, -2)) * 0.9) + "px";
                                dragElement.style.top = parseInt(dragElement.style.top.slice(0, -2)) + (0.05 * dragElement.clientHeight) + "px";
                                dragElement.style.height = (parseInt(dragElement.style.height.slice(0, -2)) * 0.9) + "px";
                            }
                        }
                    }
                    var idd = null;
                    function fallBack() {
                        // animate steak to fall back into basket
                        var toppos = dragElement.getBoundingClientRect()["top"];
                        var leftpos = dragElement.getBoundingClientRect()["left"];
                        // var toptarg = steakx.getBoundingClientRect()["top"];
                        // var lefttarg = steakx.getBoundingClientRect()["left"];
                        var ypath = toptarg - toppos;
                        var xpath = lefttarg - leftpos;
                        let ticker = 0;
                        clearInterval(idd);
                        idd = setInterval(frame, 1);
                        function frame() {
                            if (ticker == 50) {
                                dragElement.classList.add("draggable");
                                clearInterval(idd);
                                dragElement.style.position = "absolute";
                                dragElement.style.left = originL;
                                dragElement.style.top = originT;
                                dragElement.style.width = originW;
                                dragElement.style.height = originH;
                            } else {
                                ticker++;
                                dragElement.style.top = toppos + (ticker*(ypath / 50)) + "px";
                                dragElement.style.left = leftpos + (ticker*(xpath / 50)) + "px";
                            }
                        }
                    }
                    function checkMouth()
                    {
                        var elem = dragElement;
                        elemOffset = elem.getBoundingClientRect();
                        elemDisplay = elem.style.display;
                        // Temporarily hide element
                        elem.style.display = 'none';
                        // Check for top-most element at position
                        centralX = elemOffset.left + (0.5 * elemOffset.width);
                        centralY = elemOffset.top + (0.5 * elemOffset.height);
                        var topElem = document.elementFromPoint(centralX, centralY);
                        // Reset element's initial display value.
                        elem.style.display = elemDisplay;
                        // If a top-most element is a creature
                        if (topElem.classList.contains("creature")) {
                            let targetCell = elem.id + "cell";
                            //input topElem's id (ticker such as 'PLE') into session data, with key of 'steak#cell'
                            sessionStorage.setItem(targetCell, topElem.id);
                            staked ++;
                            return true;
                        } else {
                            return false;
                        }
                    }
                    if (checkMouth()) {
                        eatAnimation();
                        updateCells();
                    } else {
                        fallBack();
                    }
                }
                function moveAt(clientX, clientY) {
                    // new window-relative coordinates

                    let newX = clientX - shiftX;
                    let newY = clientY - shiftY;
                    // check if the new coordinates are below the bottom window edge
                    let newBottom = newY + dragElement.offsetHeight; // new bottom
                    // below the window? let's scroll the page
                    if (newBottom > document.documentElement.clientHeight) {
                        // window-relative coordinate of document end
                        let docBottom = document.documentElement.getBoundingClientRect().bottom;
                        // scroll the document down by 10px has a problem
                        // it can scroll beyond the end of the document
                        // Math.min(how much left to the end, 10)
                        let scrollY = Math.min(docBottom - newBottom, 10);
                        // calculations are imprecise, there may be rounding errors that lead to scrolling up
                        // that should be impossible, fix that here
                        if (scrollY < 0) scrollY = 0;
                        window.scrollBy(0, scrollY);
                        // a swift mouse move make put the cursor beyond the document end
                        // if that happens -
                        // limit the new Y by the maximally possible (right at the bottom of the document)
                        newY = Math.min(newY, document.documentElement.clientHeight - dragElement.offsetHeight);
                    }
                    // check if the new coordinates are above the top window edge (similar logic)
                    if (newY < 0) {
                        // scroll up
                        let scrollY = Math.min(-newY, 10);
                        if (scrollY < 0) scrollY = 0; // check precision errors
                        window.scrollBy(0, -scrollY);
                        // a swift mouse move can put the cursor beyond the document start
                        newY = Math.max(newY, 0); // newY may not be below 0
                    }
                    // limit the new X within the window boundaries
                    // there's no scroll here so it's simple
                    if (newX < 0) newX = 0;
                    if (newX > document.documentElement.clientWidth - dragElement.offsetWidth) {
                        newX = document.documentElement.clientWidth - dragElement.offsetWidth;
                    }

                    dragElement.style.left = newX + 'px';
                    dragElement.style.top = newY + 'px';
                }
            });

            function updateCells() {
                var cellsArray = document.getElementsByClassName("cell");
                for (let cell in cellsArray) {
                    if (sessionStorage.getItem(cellsArray[cell].id)) {
                        //alert("if condition satisfied for " + cellsArray[cell].id);
                        symbol = sessionStorage.getItem(cellsArray[cell].id);
                        //alert("it has symbol of: " + symbol);
                        // initialise the url for the GET request to retrieve the cryptocurrency data from the market on cryptocompare
                        var url = "https://min-api.cryptocompare.com/data/pricemultifull?fsyms=" + symbol + "&tsyms=USD&api_key=f766acea6e0e6deb31d36258b7392e0a6c9b414d358e5e05ba0b72478b731872";  // this works correctly
                        fetch(url).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            //initialise the variables we want to display
                            var sPower = data["DISPLAY"][symbol]["USD"]["MKTCAP"];
                            var iPower = data["DISPLAY"][symbol]["USD"]["PRICE"];
                            var growth = data["DISPLAY"][symbol]["USD"]["CHANGEPCT24HOUR"] + "%";
                            var mob = data["DISPLAY"][symbol]["USD"]["TOTALVOLUME24HTO"];
                            var pop = data["DISPLAY"][symbol]["USD"]["CIRCULATINGSUPPLY"];
                            // fill cell up with the content
                            //alert("filling cell " + cellsArray[cell].id); // maybe try finding cell with doc.getElbyId and then changing innerhtml??
                            cellsArray[cell].innerHTML =
                            "<span class='smlheader'><u>" + symbol + "</u></span><br>" +
                            "Ind' Power: " + iPower + "<br>" +
                            "Mobility: " + mob + "<br>" + 
                            "Spec' Power: " + sPower + "<br>" + 
                            "Growth: " + growth + "<br>" + 
                            "Pop: " + pop + "<br>";
                            //alert("cell " + cellsArray[cell].id + " filled")
                        });
                    }
                }
            }
            updateCells();
        </script>
        

    </body>
</html>