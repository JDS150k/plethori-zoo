<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, width=device-width">
        <!-- http://getbootstrap.com/docs/4.5/ -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <!-- https://favicon.io/emoji-favicons/money-mouth-face/ -->
        <link href="/static/ple.png" rel="icon">
        <link href="/static/styles.css" rel="stylesheet">
        <!-- http://getbootstrap.com/docs/4.5/ -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        <title>Plethori's Zoo of Crypto Creatures - {% block title %}{% endblock %}</title>
    </head>
    <body>
        <div id="frame">
            <img src="/static/frame.jpg" class="img-fluid">
            <!-- REMOVED LATERAL BUTTONS FOR NOW - WILL REPURPOSE TO CYCLE THROUGH ENCLOSURES
            <a id="switchleft" href="..."></a>
            <a id="switchright" href="..."></a>
            -->
            <div class="cell leftcell topcell" id="steak1cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak1"></div>
            </div>
            <div class="cell leftcell midcell" id="steak2cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak2"></div>
            </div>
            <div class="cell leftcell botcell" id="steak3cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak3"></div>
            </div>
            <div class="cell rightcell topcell" id="steak4cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak4"></div>
            </div>
            <div class="cell rightcell midcell" id="steak5cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak5"></div>
            </div>
            <div class="cell rightcell botcell" id="steak6cell">
                <div class="steak" id="steakx"></div>
                <div class="steak draggable" id="steak6"></div>
            </div>

            <div id="mainbox">
                {% block img %}{% endblock %}
                <div id="chat">
                    <div class="sender first" id="speech">       
                        <p>
                            <span id="prev" class="blink-txt"></span>
                            <span id="dialogue"></span>
                            <span id="next" class="blink-txt"></span>
                        </p>
                    </div>
                </div>

                <div id="minimapbox"></div>
                <a id="minimap" onclick="openMap()"></a>
                <a id="minihelp" onclick="openHelp()"></a>
                <div id="helpbox">
                    <div class="p-3" style="direction: rtl;">
                        <span class="header">Plethori Zoo Guidebook</span>
                        <p style="direction: ltr;">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. <br>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. <br>Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                            <br><br>
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. <br>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. <br>Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                        </p>
                    </div>
                    <img src="/static/close-button.png" onclick="closeHelp()" class="closer">
                </div>
                <div id="mapbox" >
                    <div id="map">
                        <img src="/static/map.png" class="img-fluid">    
                        <a href="etfx-platform" title="ETFX Platform" style="position: absolute; left: 49%; top: 52%">ETFX</a>
                        <a href="sustainable-coins" title="Sustainable Coins" style="position: absolute; left: 14.3%; top: 44.5%">Sustainable Coins</a>
                        <a href="public-coins" title="Public Coins" style="position: absolute; left: 43%; top: 82%">Public Coins</a>
                        <a href="governance-tokens" title="Governance Tokens" style="position: absolute; left: 8%; top: 63.5%">Governance Tokens</a>
                        <a href="extinct-coins" title="Extinct Coins" style="position: absolute; left: 31.5%; top: 32%">Extinct Coins</a>
                        <a href="payment-coins" title="Payment Coins" style="position: absolute; left: 73.5%; top: 65%">Payment Coins</a>
                        <a href="privacy-coins" title="Privacy Coins" style="position: absolute; left: 64%; top: 33.5%">Privacy Coins</a>
                        <a href="utility-tokens" title="Utility Tokens" style="position: absolute; left: 74%; top: 47%">Utility Tokens</a>
                        <a href="stable-coins" title="Stable Coins" style="position: absolute; left: 67%; top: 78.5%">Stable Coins</a>
                        <a href="security-tokens" title="Security Tokens" style="position: absolute; left: 13%; top: 81%">Security Tokens</a>
                    </div>
                    <img src="/static/close-button.png" onclick="closeMap()" class="closer">
                </div>
                <div id="displayer"></div>
            </div>
        </div>

        {% block txt %}{% endblock %} <!--block-txt contains an array of zookeeper dialogue-->
        
        <script> // helpbox and mapbox functionality
            var helpbox = document.getElementById("helpbox");
            var mapbox = document.getElementById("mapbox");
            var boxcounter = 99999;
            function openHelp() {
                closeMap();
                helpbox.style.visibility = "visible";
                helpbox.style.zIndex = boxcounter;
                boxcounter +=1;
            }
            function closeHelp() {
                helpbox.style.visibility = "hidden";
            }
            function openMap() {
                closeHelp();
                mapbox.style.visibility = "visible";
                mapbox.style.zIndex = boxcounter;
                boxcounter +=1;
            }
            function closeMap() {
                mapbox.style.visibility = "hidden";
            }
        </script>

        <script> // Generate & display the creature data from the live market
            var apiKey = "{{apiKey}}";
            // store all crypto-creatures in an array
            let creatures = document.getElementsByClassName("creature");
            var mainbox = document.getElementById("mainbox");
            let displayer = document.getElementById("displayer");
            // iterate over creatures to add listeners and heartbeats
            for (const creature of creatures){
                creature.addEventListener("mouseout", hideStats);
                creature.addEventListener("mouseover", showStats);
                let heart = document.createElement("div");
                heart.style.cssText = document.defaultView.getComputedStyle(creature, "").cssText;
                heart.setAttribute("style", creature.getAttribute("style"))
                heart.classList.add("heart");
                heart.style.zIndex = 98;
                mainbox.appendChild(heart);
            }
            // hide stats displayer when necessary
            function hideStats(event) {
                displayer.style.visibility = "hidden"; // hide the displayer on mouseout of creature
            }
            // render and show stats displayer when necessary
            function showStats(event) {
                var symbol = event.target.id;
                // initialise the url for the GET request to retrieve the cryptocurrency data from the market on cryptocompare
                var url = "https://min-api.cryptocompare.com/data/pricemultifull?fsyms=" + symbol + "&tsyms=USD&api_key=" + apiKey;  // this works correctly
                fetch(url).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    //initialise the variables we want to display
                    var sPower = data["DISPLAY"][symbol]["USD"]["MKTCAP"];
                    var iPower = data["DISPLAY"][symbol]["USD"]["PRICE"];
                    var growth = data["DISPLAY"][symbol]["USD"]["CHANGEPCT24HOUR"] + "%";
                    var mob = data["DISPLAY"][symbol]["USD"]["TOTALVOLUME24HTO"];
                    var pop = data["DISPLAY"][symbol]["USD"]["SUPPLY"];
                    // show the displayer div, and fill it up with content
                    displayer.innerHTML = 
                    "<span class='smlheader'><u>Creature: " + symbol + "</u></span><br>" +
                    "Individual Power (Price): " + iPower + "<br>" +
                    "Mobility (24hr Vol): " + mob + "<br>" + 
                    "Species Power (Mkt Cap): " + sPower + "<br>" + 
                    "Growth (24hr % Change): " + growth + "<br>" + 
                    "Population (Supply): " + pop + "<br>";
                    displayer.style.visibility = "visible";
                });
            }
        </script>

        <script> // dynamically render the zookeeper's speech from the array in 'block txt' 
            var txtcounter = -1;
            let next1 = document.getElementById("next");
            let prev1 = document.getElementById("prev");
            let dialogue = document.getElementById("dialogue");
            next1.addEventListener("click", NextText);
            prev1.addEventListener("click", PrevText);
            function NextText() {
                txtcounter +=1;
                renderText(txtcounter);
            }
            function PrevText() {
                txtcounter -=1;
                renderText(txtcounter);
            }
            function renderText (txtcounter) {
                dialogue.innerHTML = array[txtcounter];
                if (txtcounter >= 1) {
                    prev1.innerHTML = "&lt&lt&nbsp;&nbsp;&nbsp;";
                } else {
                    prev1.innerHTML = "";
                }
                if (txtcounter <= array.length - 2) {
                    next1.innerHTML = "&nbsp;&nbsp;&nbsp;&gt&gt";
                } else {
                    next1.innerHTML = "";
                }
            }
            NextText();
            // dynamically generate zookeeper bubbles
            // initialise keeper and bubbles
            var chatopen = false;
            var keeper = document.getElementById("zookeeper");
            var alertBub = document.createElement("div");
            alertBub.setAttribute("id", "alertbub");
            var closeBub = document.createElement("div");
            closeBub.setAttribute("id", "closebub");
            var chat = document.getElementById("chat");
            alertBub.classList.add("blink-image");
            //closeBub.classList.add("blink-image");
            keeper.appendChild(alertBub); // start with the alert bubble 
            // listen for clicks on bubbles, and show/hide chat (and change bubbles) accordingly
            keeper.addEventListener("click", function() {
                if (chatopen == false) {
                    chat.style.visibility = "visible";
                    chatopen = true;
                    keeper.removeChild(alertBub);
                    keeper.appendChild(closeBub);
                } else {
                    chat.style.visibility = "hidden";
                    chatopen = false;
                    keeper.removeChild(closeBub);
                    keeper.appendChild(alertBub);
                    alertBub.classList.remove("blink-image");
                    txtcounter = -1;
                    NextText();
                }
            });
        </script>

        
        <script>
            // STAKING FUNCTIONALITY FOR USER TO SELECT THEIR CHOICES AND MAKE A CHIMERA
            var cellsArrayRaw = document.getElementsByClassName("cell");
            var cellsArray = Array.from(cellsArrayRaw);
            var renderedBlueprint = false;
            var userChoicesDisplay = {
                "steak1cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak2cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak3cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak4cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak5cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak6cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
            }
            var userChoicesRaw = {
                "steak1cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak2cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak3cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak4cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak5cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
                "steak6cell": {"symbol": "???", "iPow": 0, "sPow": 0, "growth": 0, "mob": 0, "pop": 0},
            }
            //SOUND EFFECTS
            var zap = new sound("/static/zap.wav");
            function sound(src) {
                this.sound = document.createElement("audio");
                this.sound.src = src;
                this.sound.setAttribute("preload", "auto");
                this.sound.setAttribute("controls", "none");
                this.sound.style.display = "none";
                document.body.appendChild(this.sound);
                this.play = function(){
                    this.sound.play();
                }
                this.stop = function(){
                    this.sound.pause();
                }
            }
            
            // DRAG AND DROP FUNCTION
            let isDragging = false;
            let z = 999;
            document.addEventListener('mousedown', function(event) {
                let steakx = document.getElementById("steakx"); // Will need to change this to an array of steakx, and fallback accordingly
                var widthRatio = steakx.parentElement.clientWidth / document.documentElement.clientWidth;
                var heightRatio = steakx.parentElement.clientHeight / document.documentElement.clientHeight;
                let dragElement = event.target.closest('.draggable');
                var toptarg = dragElement.getBoundingClientRect()["top"];
                var lefttarg = dragElement.getBoundingClientRect()["left"];
                var originL = dragElement.style.left;
                var originT = dragElement.style.top;
                var originW = dragElement.style.width;
                var originH = dragElement.style.height;
                if (!dragElement) return;
                event.preventDefault();
                dragElement.style.zIndex = z;
                z++;
                dragElement.ondragstart = function() {
                    return false;
                };
                let shiftX, shiftY;

                startDrag(dragElement, event.clientX, event.clientY);
                function onMouseUp(event) {
                    finishDrag();
                };
                function onMouseMove(event) {
                    moveAt(event.clientX, event.clientY);
                }

                function startDrag(element, clientX, clientY) {
                    if(isDragging) {
                        return;
                    }
                    isDragging = true;
                    document.addEventListener('mousemove', onMouseMove);
                    element.addEventListener('mouseup', onMouseUp);
                    shiftX = clientX - element.getBoundingClientRect().left;
                    shiftY = clientY - element.getBoundingClientRect().top;
                    //account for new position fixed, which will change the size coz it goes from a % of parent to % of viewport
                    element.style.position = 'fixed';
                    element.style.width = Math.round(element.clientWidth * widthRatio) + "px";
                    element.style.height = Math.round(element.clientHeight * heightRatio) + "px";
                    moveAt(clientX, clientY);
                };

                // switch to absolute coordinates at the end, to fix the element in the document
                function finishDrag() {
                    if(!isDragging) {
                        return;
                    }
                    isDragging = false;
                    dragElement.style.top = parseInt(dragElement.style.top) + 'px';
                    dragElement.classList.remove('draggable');
                    document.removeEventListener('mousemove', onMouseMove);
                    dragElement.removeEventListener('mouseup', onMouseUp);
                    var van = null;
                    function eatAnimation() {
                        zap.play();
                        // animate steak to disappear
                        clearInterval(van);
                        van = setInterval(vanish, 1);
                        function vanish() {
                            if (dragElement.clientWidth <= 5) {
                                dragElement.classList.remove('draggable');
                                dragElement.style.display = "none";
                                clearInterval(van);
                            } else {
                                dragElement.style.left = parseInt(dragElement.style.left.slice(0, -2)) + (0.05 * dragElement.clientWidth) + "px";
                                dragElement.style.width = (parseInt(dragElement.style.width.slice(0, -2)) * 0.9) + "px";
                                dragElement.style.top = parseInt(dragElement.style.top.slice(0, -2)) + (0.05 * dragElement.clientHeight) + "px";
                                dragElement.style.height = (parseInt(dragElement.style.height.slice(0, -2)) * 0.9) + "px";
                            }
                        }
                    }
                    var idd = null;
                    // animate steak to fall back into basket if not dropped onto creature
                    function fallBack() {
                        var toppos = dragElement.getBoundingClientRect()["top"];
                        var leftpos = dragElement.getBoundingClientRect()["left"];
                        var ypath = toptarg - toppos;
                        var xpath = lefttarg - leftpos;
                        let ticker = 0;
                        clearInterval(idd);
                        idd = setInterval(frame, 1);
                        function frame() {
                            if (ticker == 50) {
                                dragElement.classList.add("draggable");
                                clearInterval(idd);
                                dragElement.style.position = "absolute";
                                dragElement.style.left = originL;
                                dragElement.style.top = originT;
                                dragElement.style.width = originW;
                                dragElement.style.height = originH;
                            } else {
                                ticker++;
                                dragElement.style.top = toppos + (ticker*(ypath / 50)) + "px";
                                dragElement.style.left = leftpos + (ticker*(xpath / 50)) + "px";
                            }
                        }
                    }
                    // Check if stake dropped onto creature
                    function checkCreature()
                    {
                        var elem = dragElement;
                        elemOffset = elem.getBoundingClientRect();
                        elemDisplay = elem.style.display;
                        // Temporarily hide element
                        elem.style.display = 'none';
                        // Check for top-most element at position
                        centralX = elemOffset.left + (0.5 * elemOffset.width);
                        centralY = elemOffset.top + (0.5 * elemOffset.height);
                        var topElem = document.elementFromPoint(centralX, centralY);
                        // Reset element's initial display value.
                        elem.style.display = elemDisplay;
                        // If a top-most element is a creature
                        if (topElem.classList.contains("creature")) {
                            let targetKey = elem.id + "cell";       //e.g. steak#cell
                            sessionStorage.setItem(targetKey, topElem.id);
                            return true;
                        } else {
                            return false;
                        }
                    }

                    if (checkCreature()) {
                        updateCells();
                        eatAnimation();
                    } else {
                        fallBack();
                    }
                }
                // MOVING STAKE WITH CURSOR
                function moveAt(clientX, clientY) {
                    // new window-relative coordinates
                    let newX = clientX - shiftX;
                    let newY = clientY - shiftY;
                    // check if the new coordinates are below the bottom window edge
                    let newBottom = newY + dragElement.offsetHeight; // new bottom
                    // below the window? let's scroll the page
                    if (newBottom > document.documentElement.clientHeight) {
                        // window-relative coordinate of document end
                        let docBottom = document.documentElement.getBoundingClientRect().bottom;
                        // scroll the document down by 10px has a problem
                        // it can scroll beyond the end of the document
                        // Math.min(how much left to the end, 10)
                        let scrollY = Math.min(docBottom - newBottom, 10);
                        // calculations are imprecise, there may be rounding errors that lead to scrolling up
                        // that should be impossible, fix that here
                        if (scrollY < 0) scrollY = 0;
                        window.scrollBy(0, scrollY);
                        // a swift mouse move make put the cursor beyond the document end
                        // if that happens -
                        // limit the new Y by the maximally possible (right at the bottom of the document)
                        newY = Math.min(newY, document.documentElement.clientHeight - dragElement.offsetHeight);
                    }
                    // check if the new coordinates are above the top window edge (similar logic)
                    if (newY < 0) {
                        // scroll up
                        let scrollY = Math.min(-newY, 10);
                        if (scrollY < 0) scrollY = 0; // check precision errors
                        window.scrollBy(0, -scrollY);
                        // a swift mouse move can put the cursor beyond the document start
                        newY = Math.max(newY, 0); // newY may not be below 0
                    }
                    // limit the new X within the window boundaries
                    // there's no scroll here so it's simple
                    if (newX < 0) newX = 0;
                    if (newX > document.documentElement.clientWidth - dragElement.offsetWidth) {
                        newX = document.documentElement.clientWidth - dragElement.offsetWidth;
                    }
                    dragElement.style.left = newX + 'px';
                    dragElement.style.top = newY + 'px';
                }
            });
            // UPDATE THE CONTENTS OF THE 6 CELLS AS CREATURES ARE STAKED/UNSTAKED
            function updateCells() {
                for (let cell in cellsArray) {
                    if (sessionStorage.getItem(cellsArray[cell].id)) {
                        let symbola = sessionStorage.getItem(cellsArray[cell].id);
                        // initialise the url for the GET request to retrieve the cryptocurrency data from the market on cryptocompare
                        let urla = "https://min-api.cryptocompare.com/data/pricemultifull?fsyms=" + symbola + "&tsyms=USD&api_key=" + apiKey;  // this works correctly
                        fetch(urla).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            //ASSIGN DISPLAY DATA OF USER CHOICES
                            userChoicesDisplay[cellsArray[cell].id]["symbol"] = symbola;
                            userChoicesDisplay[cellsArray[cell].id]["iPow"] = data["DISPLAY"][symbola]["USD"]["PRICE"];
                            userChoicesDisplay[cellsArray[cell].id]["sPow"] = data["DISPLAY"][symbola]["USD"]["MKTCAP"];
                            userChoicesDisplay[cellsArray[cell].id]["growth"] = data["DISPLAY"][symbola]["USD"]["CHANGEPCT24HOUR"] + "%";
                            userChoicesDisplay[cellsArray[cell].id]["mob"] = data["DISPLAY"][symbola]["USD"]["TOTALVOLUME24HTO"];
                            userChoicesDisplay[cellsArray[cell].id]["pop"] = data["DISPLAY"][symbola]["USD"]["SUPPLY"];
                            //ASSIGN RAW DATA OF USER CHOICES
                            userChoicesRaw[cellsArray[cell].id]["symbol"] = symbola;
                            userChoicesRaw[cellsArray[cell].id]["iPow"] = data["RAW"][symbola]["USD"]["PRICE"];
                            userChoicesRaw[cellsArray[cell].id]["sPow"] = data["RAW"][symbola]["USD"]["MKTCAP"];
                            userChoicesRaw[cellsArray[cell].id]["growth"] = data["RAW"][symbola]["USD"]["CHANGEPCT24HOUR"];
                            userChoicesRaw[cellsArray[cell].id]["mob"] = data["RAW"][symbola]["USD"]["TOTALVOLUME24HTO"];
                            userChoicesRaw[cellsArray[cell].id]["pop"] = data["RAW"][symbola]["USD"]["SUPPLY"];
                            // ASSIGN THE CREATURE STATS
                            let sPower = data["DISPLAY"][symbola]["USD"]["MKTCAP"];
                            let iPower = data["DISPLAY"][symbola]["USD"]["PRICE"];
                            let growth = data["DISPLAY"][symbola]["USD"]["CHANGEPCT24HOUR"] + "%";
                            let mob = data["DISPLAY"][symbola]["USD"]["TOTALVOLUME24HTO"];
                            let pop = data["DISPLAY"][symbola]["USD"]["SUPPLY"];
                            // FILL CELLS WITH CREATURE STATS
                            cellsArray[cell].innerHTML =
                            "<span class='smlheader'><u>" + symbola + "</u></span><br>" +
                            "Ind' Power: " + iPower + "<br>" +
                            "Mobility: " + mob + "<br>" + 
                            "Spec' Power: " + sPower + "<br>" + 
                            "Growth: " + growth + "<br>" + 
                            "Pop: " + pop + "<br>" + 
                            "<img src='static/close-button.png' style='width: 10%; height: auto' onclick='clearCell(this)'>";
                            // REFRESH PAGE IF THERE'S A CHIMERA BLUEPRINT ALREADY BEING RENDERED ONSCREEN
                            if (renderedBlueprint == true) {
                                location.reload();
                            }
                        });
                    } else {
                        //POPULATE CELL WITH A STAKE/STEAK
                        let myId = cellsArray[cell].id;
                        if (myId != undefined) {
                            cellsArray[cell].innerHTML = "<div class='steak' id='steakx'></div><div class='steak draggable' id='" + myId.slice(0, 6) + "'></div>"
                        }
                    }
                }
                return;
            }

            function clearCell(thing) {
                sessionStorage.removeItem(thing.parentElement.id);
                updateCells();
            };
            
            updateCells();

            //ADD LISTENER TO CHIMERA MACHINE
            if (document.getElementById("machine")) {
                var machine = document.getElementById("machine");
                machine.addEventListener("click", renderBlueprint);
            }
            var bluePrint = {};

            // CALCULATE CHIMERA STATS
            function renderBlueprint() {
                renderedBlueprint = true;
                var sPowerChim = 0;
                var iPowerChim = 0;
                var growthChim = 0;
                var mobChim = 0;
                var popChim = 0;
                var symbolList = [];
                
                const countOccurrences = (arr, val) => arr.reduce((a, v) => (v === val ? a + 1 : a), 0);
                for (let cell in cellsArray) {
                    symbolList.push(userChoicesDisplay[cellsArray[cell].id]["symbol"]);
                    sPowerChim += userChoicesRaw[cellsArray[cell].id]["sPow"];
                    iPowerChim += userChoicesRaw[cellsArray[cell].id]["iPow"];
                    growthChim += userChoicesRaw[cellsArray[cell].id]["growth"];
                    mobChim += userChoicesRaw[cellsArray[cell].id]["mob"];
                    popChim += userChoicesRaw[cellsArray[cell].id]["pop"];
                }
                for (let symb in symbolList) { // populate bluePrint dict with "symbol: occurences"
                    bluePrint[symbolList[symb]] = countOccurrences(symbolList, symbolList[symb]);
                }
                sPowerChim = parseFloat((sPowerChim / 6).toFixed(1));
                iPowerChim = parseFloat((iPowerChim / 6).toFixed(1));
                growthChim = parseFloat((growthChim / 6).toFixed(1));
                mobChim = parseFloat((mobChim / 6).toFixed(1));
                popChim = parseFloat((popChim / 6).toFixed(1));
                // FILL MACHINE DIV WITH CONTENTS OF CHIMERA STATS
                machine.innerHTML = "Your Chimera Blueprint is:<br>" + JSON.stringify(bluePrint) + "<br>" +
                "Individual Power: $" + iPowerChim + "<br>" +
                "Mobility: $" + mobChim.toLocaleString() + "<br>" + 
                "Species Power: $" + sPowerChim.toLocaleString() + "<br>" + 
                "Growth Rate: " + growthChim + "%<br>" + 
                "Population: " + popChim.toLocaleString() + "<br>" +
                "<button onclick='meetChimera()'>Meet Your Chimera</>";
            };

            // WHEN USER CLICKS 'MEET CHIMERA' THE PAGE WILL REFRESH WITH THE BLUEPRINT IN THE URL
            function meetChimera() {
                let bp = JSON.stringify(bluePrint);
                window.open('?bp=' + bp,'_self');
            }
            // IF THERE'S A BLUEPRINT IN THE PAGE'S URL, THE APP WILL QUERY THE DATABASE USING THE CHIMERA DATA IN THE BLUEPRINT
            // THE RETURN OF THE QUERY WILL BE A *DESCRIPTION* OF THE USER'S CHIMERA (CURRENTLY JUST DUMMY TEXT)
            // THEN THE APP PASSES THE *DESCRIPTION* VARIABLE BACK TO THIS PAGE, SO WE CAN DISPLAY IT IN THE MACHINE DIV
            function printDescription() {
                if (descrip == null) {
                    var descrip = "{{description}}";
                    console.log(descrip);
                    machine.innerHTML = descrip;
                }
            }
            printDescription();
        </script>
    </body>
</html>

